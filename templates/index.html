<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PricePing Dashboard</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>

    <nav class="navbar navbar-expand-lg custom-navbar fixed-top">
        <div class="container">
            <a class="navbar-brand logo" href="{{ url_for('dashboard') }}">
                <i class="bi bi-hexagon-half logo-icon"></i> PricePing
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon" style="filter: invert(1);"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
                <div class="navbar-nav">
                    <a class="nav-link active" href="{{ url_for('dashboard') }}">Dashboard</a>
                    <a class="nav-link" href="{{ url_for('add_product') }}">Add Product</a>
                    <a class="nav-link" href="#">Logout</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container" style="margin-top: 100px;">
        <div class="d-flex justify-content-between align-items-center mb-5 flex-wrap gap-3">
            <div>
                <h2 class="bg-gradient-title fw-bold mb-1">Track Prices. Save Smarter.</h2>
                <p class="text-muted">Real-time tracking across multiple stores.</p>
            </div>
            <button class="btn btn-primary" onclick="window.location.href='{{ url_for('add_product') }}'">
                <i class="bi bi-plus-lg"></i> Add New Tracker
            </button>
        </div>

        <div class="row">
            <!-- Main Chart Area -->
            <div class="col-lg-8 mb-4">
                <div class="glass-panel p-4 h-100">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">Price Trend Overview</h5>
                        <span class="badge monitoring"><i class="bi bi-activity"></i> Live Monitoring</span>
                    </div>
                    <div class="chart-container">
                        <canvas id="mainPriceChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Quick Stats Area -->
            <div class="col-lg-4 mb-4">
                <div class="row h-100">
                    <div class="col-12 mb-3">
                        <div class="card-custom p-4 h-100 d-flex flex-column justify-content-center">
                            <p class="text-muted mb-1">Tracked Items</p>
                            <h2 class="text-white mb-0">{{ tracked_count }} <span class="fs-6 text-success"><i
                                        class="bi bi-arrow-up-short"></i>2</span></h2>
                        </div>
                    </div>
                    <div class="col-12 mb-3">
                        <div class="card-custom p-4 h-100 d-flex flex-column justify-content-center">
                            <p class="text-muted mb-1">Total Savings</p>
                            <h2 class="text-white mb-0 format-currency" style="color: var(--electric-cyan) !important;">
                                {{ "{:.2f}".format(total_savings) }}</h2>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="card-custom p-4 h-100 d-flex flex-column justify-content-center"
                            style="background: rgba(0, 229, 255, 0.05); border-color: rgba(0, 229, 255, 0.2);">
                            <p class="text-muted mb-1">System Status</p>
                            <h5 class="text-white mb-0 d-flex align-items-center gap-2">
                                <div class="spinner-grow spinner-grow-sm text-info" role="status"></div> Tracking Active
                            </h5>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Product Cards Grid -->
        <h4 class="mb-4 mt-4 text-white">Active Trackers</h4>
        <div class="row" id="productGrid">
            {% for product in products %}
            <!-- Card {{ product[0] }} -->
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card card-custom p-4 h-100">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h5 class="mb-0 fw-bold">{{ product[1] }}</h5>
                        {% if product[5] == "Price Dropped" %}
                        <span class="badge price-dropped"><i class="bi bi-arrow-down-circle"></i> Dropped</span>
                        {% else %}
                        <span class="badge monitoring"><i class="bi bi-eye"></i> Monitoring</span>
                        {% endif %}
                    </div>
                    <!-- Clean Domain Format -->
                    <p class="text-muted small mb-3">Store: <a href="{{ product[2] }}" target="_blank"
                            class="text-info text-decoration-none">{{ product[2].replace('https://',
                            '').replace('http://', '').split('/')[0] }}</a></p>

                    <div class="row mb-3 mt-auto">
                        <div class="col-6">
                            <p class="text-muted small mb-0">Current</p>
                            <h4 class="mb-0 text-white format-currency-static">{{ product[3] }}</h4>
                        </div>
                        <div class="col-6 text-end">
                            <p class="text-muted small mb-0">Target</p>
                            <h5 class="mb-0 text-white format-currency-static" style="opacity: 0.8">{{ product[4] }}
                            </h5>
                        </div>
                    </div>

                    <div class="progress mt-2 mb-2">
                        {% if product[5] == "Price Dropped" %}
                        <div class="progress-bar"
                            style="width: 100%; box-shadow: 0 0 10px #00E676; background: linear-gradient(90deg, #00B4DB, #00E676);">
                        </div>
                        {% else %}
                        {# Calculate Progress (Mocking % logic based on target) #}
                        {% set diff = product[3] - product[4] %}
                        {% set p = 80 if diff > 0 else 100 %}
                        <div class="progress-bar" style="width: {{ p }}%;"></div>
                        {% endif %}
                    </div>
                    {% if product[5] == "Price Dropped" %}
                    <p class="text-center text-success small fw-bold mb-0 mt-2">Target Reached!</p>
                    {% else %}
                    <p class="text-center text-info small mb-0 mt-2">Dropping slowly</p>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1050; margin-top: 60px;">
        <div id="dropToast" class="toast hide" role="alert" aria-live="assertive" aria-atomic="true">
            <div
                class="toast-header border-0 bg-transparent text-white d-flex justify-content-between align-items-center pb-0">
                <strong class="me-auto text-success"><i class="bi bi-stars"></i> Price Drop Alert</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"
                    aria-label="Close"></button>
            </div>
            <div class="toast-body mt-2">
                ðŸ”¥ <span id="toastMsg">Smart Watch dropped below your target price!</span>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
        // Format static currency texts dynamically outputted by Jinja
        const formatCurrencyStatic = (amount) => "â‚¹" + parseFloat(amount).toLocaleString("en-IN", { minimumFractionDigits: 0, maximumFractionDigits: 2 });

        document.querySelectorAll('.format-currency').forEach(el => {
            el.innerText = formatCurrencyStatic(el.innerText);
        });
        document.querySelectorAll('.format-currency-static').forEach(el => {
            el.innerText = formatCurrencyStatic(el.innerText);
        });

        // 30 sec auto-refresh for live engine tracking
        setTimeout(function () {
            location.reload();
        }, 30000); 
    </script>
</body>

</html>